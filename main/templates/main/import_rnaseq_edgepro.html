{% extends "edd_base.html" %}
{% load staticfiles %}

{% block js_css %}
    {{ block.super }}

<script type="text/javascript" src="{% static 'main/js/lib/jquery/jquery.cookie.js' %}"></script>
<script type="text/javascript" src="{% static 'main/js/lib/filedrop-min.js' %}"></script>
<script type="text/javascript" src="{% static 'main/js/util2.js' %}"></script>

<script type="text/javascript">
var process_result = function (result) {
};
function submit_data (study_id) {
  var fd = new FormData(document.getElementById("data-form"));
  jQuery.ajax({
    url : "/study/" + study_id + "/import/rnaseq/process",
    type: "POST",
    data: fd,
    processData: false,
    contentType: false,
    enctype: 'multipart/form-data',
    success : function (result) {
      if (result.python_error) {
        alert(result.python_error);
      } else {
        process_result(result);
      }
    }
  });
};
$(window).load(function () {
  var study_id = $("#study-id").val();
  var filedrop_url = "/study/" + study_id + "/import/rnaseq/parse";
  $("#file-name").live("change", function () {
    $("#data-field").text("");
    submit_data(study_id);
  });
  setupFileDrop("data-field", filedrop_url, process_result, false);
  $("#process-button").click(function () { submit_data(study_id) });
});
</script>

{% endblock js_css %}

{% block head_title %}
EDGE-pro RNA-seq import
{% endblock head_title %}

{% block body_title %}
EDGE-pro RNA-seq data import
{% endblock body_title %}

{% block content %}
<form method="post" id="data-form"
      action="/study/{{ study.id }}/import/rnaseq/process">
  {% csrf_token %}
  <input type="hidden" name="action" value="parse"/>
  <input type="hidden" name="format" value="edgepro"/>
  <input type="hidden" name="assay" value="{{ assay.id }}" id="assay-id"/>

<div class="pageSection" id="dataViewDiv">
  <div class="sectionHead">
    Step 1: Data input
    <div class="helpBadgeDiv" style="float:left;">Help
      <div class="helpContent" style="width:540px;">
        <p>Input must be in tab-separated text format of the following form:
        <pre>
...</pre>
      </div>
    </div>
  </div>

  <div class="sectionContent">
    <p>This field should contain tabular gene expression data generated by
    the <a href="http://ccb.jhu.edu/software/EDGE-pro/">EDGE-pro</a> pipeline
    for prokaryotic RNA-seq analysis (<a href="http://www.ncbi.nlm.nih.gov/pubmed/23531787">Magoc et al. Evolutionary Bioinformatics 9:127-136, 2013</a>).
    The required output file will usually
    be named <tt><b>out.rpkm_0</b></tt> or similar, and lists both read counts
    and RPKMs for every gene.  This form is for processing individual results
    for a single assay or timepoint; if you need to import data from multiple
    samples (in a different format), use the
    <a href="/study/{{ study.id }}/import/rnaseq">general-purpose interface</a>.
    </p>
    <span>
      <input type="file" name="file_name" id="file-name"/>
      <button type="button" id="process-button">Process data</button>
    </span>
  </div>
</div>
</form>

<form method="post" id="rnaseqForm"
    action="/study/{{ study.id }}/import/rnaseq">
  <input type="hidden" name="format" value="edgepro"/>
  <input type="hidden" name="assay" value="{{ assay.id }}" id="assay-id"/>
  <input type="hidden" name="data_table" id="data-table" value=""/>
<div class="pageSection" id="disambiguateDiv">
  <div class="sectionHead">
    Step 2: Disambiguate data
  </div>

  <div class="sectionContent">
    <div style="margin:4px;">
      <span class="field-label">Assay name:</span>
      <span class="field-contents">{{ assay.long_name }}</span>
      <span class="field-label">Timepoint:</span>
      <span class="field-contents">
        <input type="number" name="timepoint" value="0" size="64"/> h
      </span>
    </div>
    {% if n_existing_meas %}
    <span>
        <input type="checkbox" name="remove_all" value="1" id="remove-all-box"/>
        <label for="remove-all-box">Remove all existing measurements for this
            assay</label>
    </span>
    {% else %}
    <input type="hidden" name="remove_all" value="0"/>
    {% endif %}
    <input type="submit" value="Import data"/>
  </div>
</div>

</form>

{% endblock content %}
