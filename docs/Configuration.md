# Configuring EDD

This page gives an overview of the most useful configuration options built into EDD. There are
several sources of configuration available and some are described in further detail in sections
below. Broadly speaking, each of the Docker containers used by EDD has its own configuration(s),
as well as several configuration files for Docker itself. See comments within each file for a
detailed description of some of the options.

1. __Docker-compose environment variables__: provide basic controls for loading EDD's database from
  an existing dump, or for controlling TLS and Docker configuration for controlling remote EDD
  deployments.
2. __Docker configuration files__
  These files configure EDD's docker containers and enable you to launch EDD and most of its
  dependencies with a single command.
    * `secrets.env`: Stores passwords and URL's for the various services EDD has to connect to,
      and makes them accessible to EDD's Docker containers. Make sure to control access to this
      file! Note that passwords for EDD's Docker services are established when the Docker images/
      volumes are built prior to the first run, so it's less work to configure passwords here prior
      to the first run. You can always directly interface with the services later to change the
      password, but you'll need to update this file afterward to make sure EDD works on the next
      relaunch.
    * `docker-compose.yml`: Configures EDD's docker containers as run by Docker-compose. This is
      set up by default in a working configuration, but you may want to change container
      definitions, etc. based on your computing needs / resources and deployment strategy. See the
      [Docker-compose documentation][1] for reference.
    * `docker-compose.override.yml`. This file is NOT included by default with EDD, but you may
      create one from a copy of `docker-compose.yml-example` to override any desired settings from
      `docker-compose.yml`. See comments in the example file, and the related [Docker-compose
      documentation][2] for reference.
3. __EDD appserver configuration files__: The vast majority of EDD's code runs in Django, and can
  be configured by overriding the default settings provided with EDD. See "EDD Appserver
  Configuration Files" below for more details.
4. __Other service-specific scripts and configurations files__ are available by directories
  matching each service name under `docker_services`. Drill down into these directories to find
  service-specific configurations.


## Docker-Compose Environment Variables

There's some minimal configuration available for the EDD service startup process that's exposed
via environment variables. Each item in the following list can be triggered by prepending a value
to the command, e.g.:

    EDD_HOST_DIR=/usr/local/edd/ \
        POSTGRES_DUMP_URL=postgres://edd:edd@pg.example.org:5432/edd \
        docker-compose up -d

These environment variables are included as the service containers are *built*, so take care to
rebuild the affected containers; or run `docker-compose down` and re-run `docker-compose up -d`
without the variables set. Failure to do so with the `POSTGRES_DUMP_*` variables will cause the
database to be rebuilt on every container restart.

* `EDD_HOST_DIR` changes the location where Docker will look for the EDD code. If not set, Docker
  will issue a warning that the variable will be set to an empty string. If unset or empty, Docker
  will look for EDD code in the current directory, `.`. This is fine for running Docker on a Mac
  with Docker Machine, or running directly on Linux; however, if you are running a Docker client
  on another host, this variable allows you to specify the directory containing code on the Docker
  daemon host. *If set, this value must end with a `/`*.
* `EDD_HOST_TLS` changes the location where Docker will look for certificates to use in securing
  HTTPS traffic to EDD. On first startup, the `nginx` service will generate a self-signed
  certificate for use in HTTPS. If this variable is set, then the `nginx` service will copy
  certificates from the variable location. See the README in `./docker_services/nginx` for more
  information.
* `POSTGRES_DUMP_FILE` points to a database dump file to be loaded into the `postgres` service
  database. This should be a file generated by the `pg_dump` command on an existing EDD database.
  Note that while this variable is defined, *the database will be reloaded each time the
  `appserver` container is started*, so it's best to provide the variable at the command line as
  demonstrated above.
* `POSTGRES_DUMP_URL` points to a database URL to be loaded into the `postgres` service database.
  This variable takes precedence over `POSTGRES_DUMP_FILE`. The URL should be in the format
  `postgres://{USER}:{PASSWORD}@{HOST}:{PORT}/{DATABASE_NAME}`. Note that while this variable is
  defined, *the database will be reloaded each time the `appserver` container is started*, so it
  is best to provide the variable at the command line, as demonstrated above.
* `SKIP_AUTO_MIGRATION` this is a testing safety parameter that allows you to turn off automatic
  application of database migrations during startup of EDD's `appserver` container. Migrations
  are normally applied automatically, since this is the preferred behavior for most development
  and production environments. If this variable is defined, migrations are skipped. This can
  improve safety, for instance, if targeting a test deployment at a production database to try
  out new features that aren't yet ready for prime-time. In such deployments, it's likely
  preferably to set this value in a durable fashion, e.g. in `.bashrc` or by hard-coding its value
  in your `docker-compose-override.yml`


## EDD Appserver Configuration Files
The vast majority of EDD's code runs in Django, and many of its configuration options are also
provided out-of-the-box by Django or Django-related libraries. In the style of Django, EDD includes
a number of default Python configuration files, as well as examples that are set up to make
configuration more-or-less hassle free. Most of the contained configuration parameters are defined
by Django in its [documentation][3], but several are custom configuration options defined by EDD.

EDD's Django configuration files live under `edd/settings`:
* `base.py`: defines baseline default settings that make EDD work out-of-the box. You can edit
  this file directly, but it's cleaner / easier in the long run to override its values by creating
  a `local.py`. See below for more details.
* `local.py`: sample file is provided out-of-the-box with EDD. EDD checks for its existence, and
  any configuration options you define in `local.py` will override the defaults defined in
  `base.py`. You can copy and edit 'local.py-example' to override any options you want from
  `base.py`. Note  that `local.py` is purposefully *not* added to EDD's Git repo, since its
  purpose is to define options specific to a single EDD deployment. As a result, you can update
  your EDD deployment with a simple `git pull`, followed by a relaunch.
* `celery.py`: Defines EDD's Celery configuration. EDD ships with some reasonable default settings,
  but you may have to tune Celery to work with your computing environment/demands. See Celery's
  [configuration documentation][4], as well as EDD's custom Celery configuration options defined
  in the file. Values defined here can also be overridden in your `local.py`.
* `auth.py`: Defines authentication-specific settings that can be overridden in your `local.py`

## Configuring Social Logins <a name="Social"/>
* For broad overview, refer to the [django-allauth documentation][5].
* To use a new provider:
    * Add the provider application to `INSTALLED_APPS`
    * Put logos in `./main/static/main/images/` and update styles in `./main/static/main/login.css`
* From the admin site, add a new Social application, using Client ID and Secret Key from provider
    * [Github registration](https://github.com/settings/applications/new)
    * [Google registration](https://console.developers.google.com/)
    * [LinkedIn registration](https://www.linkedin.com/secure/developer?newapp=)
* Each provider may require additional details about the application, allowed domains and/or
  URLs, etc.

[1]:    https://docs.docker.com/compose/overview/
[2]:    https://docs.docker.com/compose/extends/#/understanding-multiple-compose-files
[3]:    https://docs.djangoproject.com/en/1.9/topics/settings/
[4]:    http://docs.celeryproject.org/en/latest/configuration.html
[5]:    http://django-allauth.readthedocs.org/en/latest/index.html